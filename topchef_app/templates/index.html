<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Top Chef France Database</title>
    <style>
        body { font-family: sans-serif; margin: 20px; }
        h1, h2 { color: #333; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        tr:hover { background-color: #e2e2e2; }
        .update-section { margin-bottom: 30px; padding: 15px; border: 1px solid #ccc; background-color: #f8f8f8; border-radius: 5px;}
        .update-section label { margin-right: 10px; }
        .update-section input[type="text"] { padding: 8px; margin-right: 10px; }
        .update-section input[type="number"] { padding: 8px; margin-right: 10px; }
        .update-section button { padding: 8px 15px; cursor: pointer; }
        .status-message { margin-top: 15px; padding: 10px; border-radius: 3px; }
        .status-success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status-error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .loading { font-style: italic; color: #555; }
        #filterInput { padding: 8px; margin-bottom: 15px; width: 300px; }
    </style>
</head>
<body>

    <h1>Top Chef France Candidate Database</h1>

    <div class="update-section">
        <h2>Manual Update</h2>
        <form id="updateForm">
            <label for="chefName">Chef Name:</label>
            <input type="text" id="chefName" name="chef_name" required>
            <button type="submit">Fetch & Update All Info</button>
        </form>
        <div id="updateStatus" class="status-message" style="display: none;"></div>
    </div>

    <div class="update-section">
        <h2>Season Update</h2>
        <form id="updateSeasonForm">
            <label for="seasonNumber">Season Number:</label>
            <input type="number" id="seasonNumber" name="season_number" min="1" required>
            <button type="submit">Fetch & Fill Season</button>
        </form>
        <div id="updateSeasonStatus" class="status-message" style="display: none;"></div>
    </div>

    <div class="update-section">
        <h2>Full Data Completion</h2>
        <button id="updateAllCandidatesBtn">Fill All Missing Data for All Candidates</button>
        <div id="updateAllCandidatesStatus" class="status-message" style="display: none;"></div>
    </div>

    <h2>Candidate Data</h2>

    <label for="filterInput">Filter Table:</label>
    <input type="text" id="filterInput" onkeyup="filterTable()" placeholder="Search for names, restaurants, seasons...">

    <table id="candidatesTable">
        <thead>
            <tr>
                <th>Chef Name</th>
                <th>Restaurant Name</th>
                <th>Restaurant Address</th>
                <th>Top Chef Season</th>
                <th>Culinary Style</th>
                <th>Career Highlights</th>
                <th>Signature Dish</th>
                <th>Last Updated (UTC)</th>
            </tr>
        </thead>
        <tbody>
            {% if candidates %}
                {% for candidate in candidates %}
                <tr>
                    <td>{{ candidate.chef_name or 'N/A' }}</td>
                    <td>{{ candidate.restaurant_name or 'N/A' }}</td>
                    <td>{{ candidate.restaurant_address or 'N/A' }}</td>
                    <td>{{ candidate.top_chef_season or 'N/A' }}</td>
                    <td>{{ candidate.culinary_style or 'N/A' }}</td>
                    <td>{{ candidate.career_highlights or 'N/A' }}</td>
                    <td>{{ candidate.signature_dish or 'N/A' }}</td>
                    <td>{{ candidate.last_updated.strftime('%Y-%m-%d %H:%M:%S') if candidate.last_updated else 'N/A' }}</td>
                </tr>
                {% endfor %}
            {% else %}
                <tr>
                    <td colspan="8">No candidates found in the database.</td>
                </tr>
            {% endif %}
        </tbody>
    </table>

    <script>
        // Simple table filtering function
        function filterTable() {
            const input = document.getElementById("filterInput");
            const filter = input.value.toUpperCase();
            const table = document.getElementById("candidatesTable");
            const tr = table.getElementsByTagName("tr");

            for (let i = 1; i < tr.length; i++) { // Start from 1 to skip header row
                let display = "none";
                const tds = tr[i].getElementsByTagName("td");
                for (let j = 0; j < tds.length; j++) {
                    const td = tds[j];
                    if (td) {
                        const txtValue = td.textContent || td.innerText;
                        if (txtValue.toUpperCase().indexOf(filter) > -1) {
                            display = "";
                            break; // Show row if any cell matches
                        }
                    }
                }
                tr[i].style.display = display;
            }
        }

        // Handle manual update form submission
        const updateForm = document.getElementById('updateForm');
        const updateStatus = document.getElementById('updateStatus');
        const chefNameInput = document.getElementById('chefName');

        updateForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const chefName = chefNameInput.value.trim();
            if (!chefName) return;

            updateStatus.textContent = 'Updating... Please wait.';
            updateStatus.className = 'status-message loading';
            updateStatus.style.display = 'block';

            try {
                const response = await fetch('/update-candidate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ chef_name: chefName }),
                });
                const result = await response.json();
                if (result.success) {
                    updateStatus.textContent = `Successfully updated information for ${chefName}. Refreshing page...`;
                    updateStatus.className = 'status-message status-success';
                    // Reload the page to show updated data after a short delay
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                } else {
                    updateStatus.textContent = `Error: ${result.message || 'Failed to update candidate.'}`;
                    updateStatus.className = 'status-message status-error';
                }
            } catch (error) {
                console.error('Update error:', error);
                updateStatus.textContent = 'An unexpected error occurred during the update.';
                updateStatus.className = 'status-message status-error';
            }
        });

        // Handle season update form submission
        const updateSeasonForm = document.getElementById('updateSeasonForm');
        const updateSeasonStatus = document.getElementById('updateSeasonStatus');
        const seasonNumberInput = document.getElementById('seasonNumber');

        updateSeasonForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const seasonNumber = seasonNumberInput.value.trim();
            if (!seasonNumber) return;

            updateSeasonStatus.textContent = 'Updating season... Please wait.';
            updateSeasonStatus.className = 'status-message loading';
            updateSeasonStatus.style.display = 'block';

            try {
                const response = await fetch('/update-season', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ season_number: seasonNumber }),
                });
                const result = await response.json();
                if (result.success) {
                    updateSeasonStatus.textContent = `Successfully updated information for season ${seasonNumber}. Refreshing page...`;
                    updateSeasonStatus.className = 'status-message status-success';
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                } else {
                    updateSeasonStatus.textContent = `Error: ${result.message || 'Failed to update season.'}`;
                    updateSeasonStatus.className = 'status-message status-error';
                }
            } catch (error) {
                console.error('Update season error:', error);
                updateSeasonStatus.textContent = 'An unexpected error occurred during the season update.';
                updateSeasonStatus.className = 'status-message status-error';
            }
        });

        // Handle full data completion button
        const updateAllCandidatesBtn = document.getElementById('updateAllCandidatesBtn');
        const updateAllCandidatesStatus = document.getElementById('updateAllCandidatesStatus');
        if (updateAllCandidatesBtn) {
            updateAllCandidatesBtn.addEventListener('click', async () => {
                updateAllCandidatesStatus.textContent = 'Starting full data completion... Please wait.';
                updateAllCandidatesStatus.className = 'status-message loading';
                updateAllCandidatesStatus.style.display = 'block';
                try {
                    const response = await fetch('/update-all-candidates', {
                        method: 'POST',
                    });
                    const result = await response.json();
                    if (result.success) {
                        updateAllCandidatesStatus.textContent = 'Full data completion task started. Check logs for progress.';
                        updateAllCandidatesStatus.className = 'status-message status-success';
                    } else {
                        updateAllCandidatesStatus.textContent = `Error: ${result.message || 'Failed to start full data completion.'}`;
                        updateAllCandidatesStatus.className = 'status-message status-error';
                    }
                } catch (error) {
                    updateAllCandidatesStatus.textContent = 'An unexpected error occurred.';
                    updateAllCandidatesStatus.className = 'status-message status-error';
                }
            });
        }
    </script>

</body>
</html>
